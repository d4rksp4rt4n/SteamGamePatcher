name: Test Unify DB Only
on:
  workflow_dispatch:  # Manual trigger for testing

jobs:
  test-unify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure data folder
        run: mkdir -p database/data

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests fuzzywuzzy python-levenshtein

      - name: Fetch patches_data.json from PRIVATE nukige-site
        env:
          TOKEN: ${{ secrets.NUKIGE_TOKEN }}
        run: |
          API_URL="https://api.github.com/repos/d4rksp4rt4n/nukige-site/contents/cache/patches_data.json"
          RESPONSE=$(curl -s -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "$API_URL")
          DOWNLOAD_URL=$(echo "$RESPONSE" | jq -r '.download_url')
          curl -L -H "Authorization: token $TOKEN" \
               "$DOWNLOAD_URL" \
               -o database/data/patches_data.json
          echo "Downloaded: $(du -h database/data/patches_data.json | cut -f1)"

      - name: Debug patches_data.json
        run: |
          ls -la database/data/patches_data.json
          head -n 5 database/data/patches_data.json 2>/dev/null || echo "File empty/invalid"

      - name: Run Unify Databases (Test)
        run: python database/unify_db.py

      - name: Debug after unify (optional)
        run: |
          if [ -f database/data/patches_database.json ]; then
            echo "Unify succeeded - output file exists"
            head -n 10 database/data/patches_database.json
          else
            echo "Unify failed - no output file"
          fi
